<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Duplication des Co√ªts - Plateforme WLC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .duplicate { background-color: #fff3cd; }
        .unique { background-color: #d1ecf1; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîç Diagnostic Duplication des Co√ªts</h1>
        <p class="text-muted">Analyse des attributions pour identifier les duplications de co√ªts</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Analyse par Groupe Uniformat</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="uniformat-select" class="form-label">S√©lectionner un groupe Uniformat :</label>
                            <select class="form-select" id="uniformat-select">
                                <option value="">Choisir un groupe...</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="analyzeUniformatGroup()">Analyser ce Groupe</button>
                        <div id="uniformat-analysis" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Analyse Globale</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="analyzeAllDuplications()">Analyser Toutes les Duplications</button>
                        <div id="global-analysis" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>D√©tails des Attributions</h5>
                    </div>
                    <div class="card-body">
                        <div id="attributions-details"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Co√ªts R√©els vs Attribu√©s</h5>
                    </div>
                    <div class="card-body">
                        <div id="cost-comparison"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Tableau de Diagnostic D√©taill√©</h5>
                    </div>
                    <div class="card-body">
                        <div id="detailed-table"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let elements = [];
        let attributions = [];
        let stakeholders = [];

        // Chargement automatique au d√©marrage
        window.addEventListener('load', function() {
            loadData();
        });

        async function loadData() {
            try {
                // Charger les √©l√©ments IFC
                const elementsResponse = await fetch('/get-ifc-elements');
                elements = await elementsResponse.json();
                
                // Charger les parties prenantes
                const stakeholdersResponse = await fetch('/api/stakeholders');
                const stakeholdersData = await stakeholdersResponse.json();
                stakeholders = stakeholdersData.success ? stakeholdersData.stakeholders : [];
                
                // Charger les attributions brutes
                const attributionsResponse = await fetch('/api/debug-attributions');
                const attributionsData = await attributionsResponse.json();
                attributions = attributionsData.success ? attributionsData.attributions : [];
                
                // Peupler le s√©lecteur Uniformat
                populateUniformatSelector();
                
                console.log('Donn√©es charg√©es:', {
                    elements: elements.length,
                    stakeholders: stakeholders.length,
                    attributions: attributions.length
                });
                
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
            }
        }

        function populateUniformatSelector() {
            const selector = document.getElementById('uniformat-select');
            const uniformatCodes = new Set();
            
            elements.forEach(element => {
                if (element.Uniformat) {
                    uniformatCodes.add(element.Uniformat);
                }
            });
            
            Array.from(uniformatCodes).sort().forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                selector.appendChild(option);
            });
        }

        async function analyzeUniformatGroup() {
            const selectedUniformat = document.getElementById('uniformat-select').value;
            if (!selectedUniformat) {
                alert('Veuillez s√©lectionner un groupe Uniformat');
                return;
            }
            
            const resultDiv = document.getElementById('uniformat-analysis');
            resultDiv.innerHTML = '<div class="info">üîÑ Analyse en cours...</div>';
            
            try {
                // Trouver les √©l√©ments de ce groupe
                const groupElements = elements.filter(el => el.Uniformat === selectedUniformat);
                
                // Calculer les co√ªts r√©els du groupe
                let realConstructionCost = 0;
                let realEndOfLifeCost = 0;
                
                groupElements.forEach(element => {
                    realConstructionCost += parseFloat(element.ConstructionCost || 0);
                    realEndOfLifeCost += parseFloat(element.EndOfLifeCost || 0);
                });
                
                // Analyser les attributions pour ce groupe
                const groupAttributions = attributions.filter(attr => {
                    const costKey = attr.cost.split('#')[1];
                    return costKey && (
                        costKey.includes('_ConstructionCosts') || 
                        costKey.includes('_EndOfLifeCosts')
                    ) && groupElements.some(el => costKey.startsWith(el.GlobalId));
                });
                
                // Compter les duplications
                const costCounts = {};
                groupAttributions.forEach(attr => {
                    const costKey = attr.cost.split('#')[1];
                    costCounts[costKey] = (costCounts[costKey] || 0) + 1;
                });
                
                // Calculer les co√ªts attribu√©s
                let attributedConstructionCost = 0;
                let attributedEndOfLifeCost = 0;
                
                Object.keys(costCounts).forEach(costKey => {
                    const element = groupElements.find(el => costKey.startsWith(el.GlobalId));
                    if (element) {
                        const count = costCounts[costKey];
                        if (costKey.includes('_ConstructionCosts')) {
                            attributedConstructionCost += parseFloat(element.ConstructionCost || 0) * count;
                        } else if (costKey.includes('_EndOfLifeCosts')) {
                            attributedEndOfLifeCost += parseFloat(element.EndOfLifeCost || 0) * count;
                        }
                    }
                });
                
                // Afficher les r√©sultats
                let html = `
                    <div class="alert alert-info">
                        <h6>Analyse du groupe ${selectedUniformat}</h6>
                        <p><strong>√âl√©ments dans le groupe :</strong> ${groupElements.length}</p>
                        <p><strong>Attributions trouv√©es :</strong> ${groupAttributions.length}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <h6>Co√ªts R√©els</h6>
                            <p>Construction : ${realConstructionCost.toLocaleString('fr-FR')} $</p>
                            <p>Fin de vie : ${realEndOfLifeCost.toLocaleString('fr-FR')} $</p>
                            <p><strong>Total : ${(realConstructionCost + realEndOfLifeCost).toLocaleString('fr-FR')} $</strong></p>
                        </div>
                        <div class="col-6">
                            <h6>Co√ªts Attribu√©s</h6>
                            <p>Construction : ${attributedConstructionCost.toLocaleString('fr-FR')} $</p>
                            <p>Fin de vie : ${attributedEndOfLifeCost.toLocaleString('fr-FR')} $</p>
                            <p><strong>Total : ${(attributedConstructionCost + attributedEndOfLifeCost).toLocaleString('fr-FR')} $</strong></p>
                        </div>
                    </div>
                `;
                
                // Analyser les duplications
                const duplicatedCosts = Object.keys(costCounts).filter(key => costCounts[key] > 1);
                if (duplicatedCosts.length > 0) {
                    html += `
                        <div class="alert alert-warning">
                            <h6>üö® Duplications d√©tect√©es :</h6>
                            <ul>
                    `;
                    duplicatedCosts.forEach(costKey => {
                        html += `<li>${costKey} : <strong>${costCounts[costKey]} fois</strong></li>`;
                    });
                    html += '</ul></div>';
                }
                
                resultDiv.innerHTML = html;
                
                // Afficher le tableau d√©taill√©
                displayDetailedTable(groupElements, groupAttributions, costCounts);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${error.message}</div>`;
            }
        }

        function displayDetailedTable(groupElements, groupAttributions, costCounts) {
            const tableDiv = document.getElementById('detailed-table');
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th>√âl√©ment (GlobalId)</th>
                                <th>Co√ªt Construction</th>
                                <th>Co√ªt Fin de Vie</th>
                                <th>Attributions Construction</th>
                                <th>Attributions Fin de Vie</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            groupElements.forEach(element => {
                const constructionKey = `${element.GlobalId}_ConstructionCosts`;
                const endOfLifeKey = `${element.GlobalId}_EndOfLifeCosts`;
                
                const constructionCount = costCounts[constructionKey] || 0;
                const endOfLifeCount = costCounts[endOfLifeKey] || 0;
                
                const isDuplicated = constructionCount > 1 || endOfLifeCount > 1;
                const rowClass = isDuplicated ? 'duplicate' : 'unique';
                
                html += `
                    <tr class="${rowClass}">
                        <td><code>${element.GlobalId}</code></td>
                        <td>${parseFloat(element.ConstructionCost || 0).toLocaleString('fr-FR')} $</td>
                        <td>${parseFloat(element.EndOfLifeCost || 0).toLocaleString('fr-FR')} $</td>
                        <td>${constructionCount} fois</td>
                        <td>${endOfLifeCount} fois</td>
                        <td>
                            ${isDuplicated ? 
                                '<span class="badge bg-warning">Dupliqu√©</span>' : 
                                '<span class="badge bg-success">Unique</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        async function analyzeAllDuplications() {
            const resultDiv = document.getElementById('global-analysis');
            resultDiv.innerHTML = '<div class="info">üîÑ Analyse globale en cours...</div>';
            
            try {
                // Compter toutes les duplications
                const costCounts = {};
                attributions.forEach(attr => {
                    const costKey = attr.cost.split('#')[1];
                    if (costKey) {
                        costCounts[costKey] = (costCounts[costKey] || 0) + 1;
                    }
                });
                
                const duplicatedCosts = Object.keys(costCounts).filter(key => costCounts[key] > 1);
                const totalDuplications = duplicatedCosts.reduce((sum, key) => sum + (costCounts[key] - 1), 0);
                
                // Analyser par partie prenante
                const stakeholderImpacts = {};
                stakeholders.forEach(stakeholder => {
                    stakeholderImpacts[stakeholder.uri] = {
                        name: stakeholder.name,
                        realCost: 0,
                        attributedCost: 0,
                        duplications: 0
                    };
                });
                
                // Calculer les impacts r√©els vs attribu√©s
                attributions.forEach(attr => {
                    const costKey = attr.cost.split('#')[1];
                    if (costKey && stakeholderImpacts[attr.stakeholder]) {
                        const elementId = costKey.split('_')[0];
                        const element = elements.find(el => el.GlobalId === elementId);
                        
                        if (element) {
                            let costValue = 0;
                            if (costKey.includes('_ConstructionCosts')) {
                                costValue = parseFloat(element.ConstructionCost || 0);
                            } else if (costKey.includes('_EndOfLifeCosts')) {
                                costValue = parseFloat(element.EndOfLifeCost || 0);
                            } else if (costKey.includes('_OperationCosts')) {
                                costValue = parseFloat(element.OperationCost || 0);
                            } else if (costKey.includes('_MaintenanceCosts')) {
                                costValue = parseFloat(element.MaintenanceCost || 0);
                            }
                            
                            stakeholderImpacts[attr.stakeholder].attributedCost += costValue;
                            
                            if (costCounts[costKey] === 1) {
                                stakeholderImpacts[attr.stakeholder].realCost += costValue;
                            } else {
                                stakeholderImpacts[attr.stakeholder].duplications += costValue * (costCounts[costKey] - 1);
                            }
                        }
                    }
                });
                
                let html = `
                    <div class="alert alert-info">
                        <h6>R√©sum√© Global</h6>
                        <p><strong>Total attributions :</strong> ${attributions.length}</p>
                        <p><strong>Co√ªts dupliqu√©s :</strong> ${duplicatedCosts.length}</p>
                        <p><strong>Duplications suppl√©mentaires :</strong> ${totalDuplications}</p>
                    </div>
                    
                    <h6>Impact par Partie Prenante :</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Partie Prenante</th>
                                    <th>Co√ªt R√©el</th>
                                    <th>Co√ªt Attribu√©</th>
                                    <th>Surplus (Duplication)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.values(stakeholderImpacts).forEach(impact => {
                    if (impact.attributedCost > 0) {
                        html += `
                            <tr>
                                <td>${impact.name}</td>
                                <td>${impact.realCost.toLocaleString('fr-FR')} $</td>
                                <td>${impact.attributedCost.toLocaleString('fr-FR')} $</td>
                                <td class="${impact.duplications > 0 ? 'text-danger' : 'text-success'}">
                                    ${impact.duplications.toLocaleString('fr-FR')} $
                                </td>
                            </tr>
                        `;
                    }
                });
                
                html += '</tbody></table></div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur : ${error.message}</div>`;
            }
        }
    </script>
</body>
</html> 